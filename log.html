<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-store">
  <title>TEST by IK4LZH</title>
  <link rel="stylesheet" href="log.css?v=107">
</head>
<body>
<div id="hh1">
  <input id="l01" placeholder="login" maxlength="6" minlength="4" required>
  <input id="l02" type="password" placeholder="password" maxlength="16" minlength="6" required>
  <button id="l03">LISTA</button>
</div>
<div id="hh2">
  <table>
    <td><pre>
      Call <input type="text" id="call"><br>
      <button id="a23">Start</button>
    </pre></td>
    <td id="myq1">
      <button id="a01">List</button><button id="a02">&#8679;</button><button id="a03">&#8681;</button><button id="a04">R</button><button id="a05">G</button><br>
      <button id="a06">Find</button><button id="a07">&#8679;</button><button id="a08">&#8681;</button><br>
      <button id="a09">Apply</button><button id="a10">Report</button><br>
      <button id="a11">Curio</button><button id="a12">Activity</button>
    </td>
    <td id="myq1">
      <input type="file" id="ff" style="width: 300px"><br>
      <button id="a15">adi&#8680;</button><button id="a16">lzh&#8680;</button><button id="a20">&#8680;adi</button><button id="a21">&#8680;cbr</button><br>
      <button id="a17">QSL.lotw</button><button id="a18">QSL.eqsl</button><button id="a19">QSL.qrz</button><br>
      <button id="a22">cbr&#8680;c</button><br>
    </td>
    <td id="myq1">
      <button id="a13">ReSerialize1m</button><br>
      <button id="a14">ReSerialize6m</button>
    </td>
  </table>
</div>
<div id="out"></div>
<div id="debug"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script type="module">
const out = document.getElementById("out");
const callInput = document.getElementById("call");
const l01 = document.getElementById("l01");
const l02 = document.getElementById("l02");
callInput.addEventListener("keydown", e => {
  if (e.key === ",") e.preventDefault();
});
callInput.addEventListener("input", e => {
  if (callInput.value.includes(",")) {
    callInput.value = callInput.value.replace(/,/g, "");
  }
});
let page = 0;
let mypage = 30;
let ota = "";
document.querySelectorAll("button[id]").forEach(btn => {
  if (/^a\d{2}$/.test(btn.id)) {
    btn.addEventListener("click", async () => {
      const num = parseInt(btn.id.slice(1), 10);
      if (num == 1 || num == 6) page = 0;
      else if (num == 2 || num == 7) page -= mypage;
      else if (num == 3 || num == 8) page += mypage;
      let data = "";
      if (num >= 15 && num <= 22) {
        const file = document.getElementById("ff").files[0];
        if (file) {
          const plainStream = file.stream();
          const plainBlob = await new Response(plainStream).blob();
          const buf = await plainBlob.arrayBuffer();
          let chunk = 0x8000, bytes = new Uint8Array([...new Uint8Array(buf), 0x20, 0x20, 0x20, 0x20]);
          let binary = "";
          for (let i = 0; i < bytes.length; i += chunk) {
            binary += String.fromCharCode(...bytes.subarray(i, i + chunk));
          }
          data = btoa(binary);
        }
      }
      if (page < 0) page = 0;
      const r = await fetch("proclog.cgi", {
        method: "POST", cache: "no-store", credentials: "same-origin",
        headers: {"Content-Type": "text/csv"},
        body: [ota,btn.id,page,mypage,callInput.value.trim().toUpperCase()||"-",data].join(",")
      });
      if (num == 5) {
        page = parseInt(await r.text(), 10) || 0;
        document.getElementById("a04").click();
      }
      else out.innerHTML = await r.text();
    });
  }
  if (btn.id === "l03") {
    btn.addEventListener("click", async () => {
      const r = await fetch("plogin.cgi", {
        method: "POST", cache: "no-store", credentials: "same-origin",
        headers: {"Content-Type": "text/csv"},
        body: [l01.value.trim().toUpperCase(),CryptoJS.MD5(l02.value).toString()].join(",")
      });
      ota = (await r.text()).trim();
      if (ota.length === 16) {
        hh2.style.display = "block";
        hh1.style.display = "none";
      }
      debug.innerHTML = `${ota}`;
    });
  }
});

window.cmd1 = async (a,b) => {
  const p = prompt("DEL DELETE FT:xxx FREQTX:xxx FR:xxx FREQRX:xxx M:xxx MODE:xxx ST:xxx SIGNALTX:xxx SR:xxx SIGNALRX:xxx C:xxx CALL:xxx DT:xxx DATETIME:xxx CO:xxx CONTEST:xxx COT:xxx CONTESTTX:xxx COR:xxx CONTESTRX:xxx","");
  if (p) {
    const r = await fetch("pcmd.cgi", {
      method: "POST",
      cache: "no-store",
      credentials: "same-origin",
      headers: { "Content-Type": "text/csv" },
      body: [ota, a, b, p].join(",")
    });
  }
};
  
hh2.style.display = "none";
hh1.style.display = "block";
  
</script>

</body>

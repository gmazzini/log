<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-store">
  <title>TEST by IK4LZH</title>
  <link rel="stylesheet" href="log.css?v=113">
</head>
<body>
<div id="hh1">
  <input class="myf2" id="l01" placeholder="login" maxlength="6" minlength="4" required>
  <input class="myf2" id="l02" type="password" placeholder="password" maxlength="16" minlength="6" required>
  <button class="btn" id="l03">LISTA</button>
</div>
<div id="hh2">
  <table>
    <td>
      <label class="myf1">Call </label>
      <input class="myf2" id="call" maxlength="20" size="10" autocomplete="off"><br>
      <label class="myf1">Freq </label>
      <input class="myf2" id="freq" maxlength="10" size="10" autocomplete="off"><br>
      <label class="myf1">Mode </label>
      <input class="myf2" type="text" id="mode" maxlength="8" size="6" autocomplete="off"><br>
      <label class="myf1">SigTX </label>
      <input class="myf2" type="text" id="sigtx" maxlength="10" size="6" autocomplete="off"><br>
      <label class="myf1">SigRX </label>
      <input class="myf2" type="text" id="sigrx" maxlength="10" size="6" autocomplete="off"><br>
      <label class="myf1">Contest </label>
      <input class="myf2" type="text" id="contest" maxlength="12" size="12" autocomplete="off"><br>
      <label class="myf1">ConTx </label>
      <input class="myf2" type="text" id="contx" maxlength="12" size="12" autocomplete="off"><br>
      <label class="myf1">ConRx </label>
      <input class="myf2" type="text" id="conrx" maxlength="12" size="12" autocomplete="off"><br>
      <button class="btn" id="a23">Start</button><button class="btn" id="a26">End</button><br>
      <button class="btn" id="a24">QRZ.com</button><button class="btn" id="a25">QRZ.ru</button>
    </td>
    <td class="myq1">
      <button class="btn" id="a01">List</button><button class="btn" id="a02">&#8679;</button><button class="btn" id="a03">&#8681;</button><button class="btn" id="a04">R</button><button class="btn" id="a05">G</button><br>
      <button class="btn" id="a06">Find</button><button class="btn" id="a07">&#8679;</button><button class="btn" id="a08">&#8681;</button><br>
      <button class="btn" id="a09">Apply</button><button class="btn" id="a10">Report</button><br>
      <button class="btn" id="a11">Curio</button><button class="btn" id="a12">Activity</button>
    </td>
    <td class="myq1">
      TX:<span id="c02"></span><br>
      MODE:<span id="c03"></span><br>
      <button class="btn" id="b01">RigOO</button><span id="c01"></span>
    </td>
    <td class="myq1">
      <input type="file" id="ff" style="width: 300px"><br>
      <button class="btn" id="a15">adi&#8680;</button><button class="btn" id="a16">lzh&#8680;</button><button class="btn" id="a20">&#8680;adi</button><button class="btn" id="a21">&#8680;cbr</button><br>
      <button class="btn" id="a17">QSL.lotw</button><button class="btn" id="a18">QSL.eqsl</button><button class="btn" id="a19">QSL.qrz</button><br>
      <button class="btn" id="a22">cbr&#8680;c</button><br>
    </td>
    <td class="myq1">
      <button class="btn" id="a13">ReSerialize1m</button><br>
      <button class="btn" id="a14">ReSerialize6m</button>
    </td>
  </table>
</div>
<div class="out" id="out"></div>
<div id="debug"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script type="module">
const out = document.getElementById("out");
const l01 = document.getElementById("l01");
const l02 = document.getElementById("l02");
const b01 = document.getElementById("b01");
let s01 = false;
const inputs = ["call", "freq", "mode", "sigtx", "sigrx", "contest", "contx", "conrx"];
inputs.forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("keydown", e => {
    if (e.key === ",") e.preventDefault();
  });
  el.addEventListener("input", () => {
    el.value = el.value.replace(/,/g, "").toUpperCase();
  });
});

let page = 0;
let mypage = 30;
let ota = "";
document.querySelectorAll("button[id]").forEach(btn => {
  if (/^a\d{2}$/.test(btn.id)) {
    btn.addEventListener("click", async () => {
      const num = parseInt(btn.id.slice(1), 10);
      if (num == 1 || num == 6) page = 0;
      else if (num == 2 || num == 7) page -= mypage;
      else if (num == 3 || num == 8) page += mypage;
      let data = "";
      if (num >= 15 && num <= 22) {
        const file = document.getElementById("ff").files[0];
        if (file) {
          const plainStream = file.stream();
          const plainBlob = await new Response(plainStream).blob();
          const buf = await plainBlob.arrayBuffer();
          let chunk = 0x8000, bytes = new Uint8Array([...new Uint8Array(buf), 0x20, 0x20, 0x20, 0x20]);
          let binary = "";
          for (let i = 0; i < bytes.length; i += chunk) {
            binary += String.fromCharCode(...bytes.subarray(i, i + chunk));
          }
          data = btoa(binary);
        }
      }
      if (page < 0) page = 0;
      const body = [
        ota,
        btn.id,
        page,
        mypage,
        ...inputs.map(id => document.getElementById(id)?.value.trim() || "-"),
        data
      ].join(",");
      const r = await fetch("proclog.cgi", {
        method: "POST", cache: "no-store", credentials: "same-origin",
        headers: {"Content-Type": "text/csv"},
        body
      });
      if (num == 5) {
        page = parseInt(await r.text(), 10) || 0;
        document.getElementById("a04").click();
      }
      else out.innerHTML = await r.text();
    });
  }
  if (btn.id === "l03") {
    btn.addEventListener("click", async () => {
      const r = await fetch("plogin.cgi", {
        method: "POST", cache: "no-store", credentials: "same-origin",
        headers: {"Content-Type": "text/csv"},
        body: [l01.value.trim().toUpperCase(),CryptoJS.MD5(l02.value).toString()].join(",")
      });
      ota = (await r.text()).trim();
      if (ota.length === 16) {
        hh2.style.display = "block";
        hh1.style.display = "none";
      }
      debug.innerHTML = `${ota}`;
    });
  }
});

window.cmd1 = async (a,b) => {
  const p = prompt("DEL DELETE FT:xxx FREQTX:xxx FR:xxx FREQRX:xxx M:xxx MODE:xxx ST:xxx SIGNALTX:xxx SR:xxx SIGNALRX:xxx C:xxx CALL:xxx DT:xxx DATETIME:xxx CO:xxx CONTEST:xxx COT:xxx CONTESTTX:xxx COR:xxx CONTESTRX:xxx","");
  if (p) {
    const r = await fetch("pcmd.cgi", {
      method: "POST",
      cache: "no-store",
      credentials: "same-origin",
      headers: { "Content-Type": "text/csv" },
      body: [ota, a, b, p.toUpperCase()].join(",")
    });
  }
};

async function radioread() {
  if (!s01) return;
  const r = await fetch("pradioread.cgi", {
    method: "POST",
    cache: "no-store",
    credentials: "same-origin",
    headers: { "Content-Type": "text/csv" },
    body: ota
  });
  const text = await r.text();
  const [freq, mode] = text.split(",");
  
  document.getElementById("freq").value = (freq / 1000).toFixed(1);
  document.getElementById("mode").value = mode;
}
setInterval(radioread, 10000);
radioread();

b01.addEventListener("click", () => {
  s01 = !s01;
  if (s01) {
    document.getElementById("freq").disabled = true;
    document.getElementById("mode").disabled = true;
    document.getElementById("c01").textContent = "On";
  } 
  else {
    document.getElementById("freq").disabled = false;
    document.getElementById("mode").disabled = false;
    document.getElementById("c01").textContent = "Off";
  } 
});
  
document.getElementById("c01").textContent = "Off";
hh2.style.display = "none";
hh1.style.display = "block";
document.getElementById("sigtx").value = "59";
document.getElementById("sigrx").value = "59";
  
</script>

</body>

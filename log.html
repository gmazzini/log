<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-store">
  <title>TEST by IK4LZH</title>
  <link rel="stylesheet" href="log.css?v=114">
</head>
<body>
<div id="hh1">
  <input class="myf2" id="l01" placeholder="login" maxlength="6" minlength="4" required>
  <input class="myf2" id="l02" type="password" placeholder="password" maxlength="16" minlength="6" required>
  <button class="btn" id="l03">LISTA</button>
</div>
<div id="hh2">
  <table>
    <td class="myq1">
      <label class="myf1">Call </label>
      <input class="myf2" id="call" maxlength="20" size="10" autocomplete="off"><br>
      <label class="myf1">Freq </label>
      <input class="myf2" id="freq" maxlength="10" size="10" autocomplete="off"><br>
      <label class="myf1">Mode </label>
      <input class="myf2" type="text" id="mode" maxlength="8" size="6" autocomplete="off"><br>
      <label class="myf1">SigTX </label>
      <input class="myf2" type="text" id="sigtx" maxlength="10" size="6" autocomplete="off"><br>
      <label class="myf1">SigRX </label>
      <input class="myf2" type="text" id="sigrx" maxlength="10" size="6" autocomplete="off"><br>
      <label class="myf1">Contest </label>
      <input class="myf2" disabled type="text" id="contest" maxlength="12" size="12" autocomplete="off"><br>
      <label class="myf1">ConTx </label>
      <input class="myf2" disabled type="text" id="contx" maxlength="12" size="12" autocomplete="off"><br>
      <label class="myf1">ConRx </label>
      <input class="myf2" disabled type="text" id="conrx" maxlength="12" size="12" autocomplete="off"><br>
      <button class="btn" id="a23">Start</button><button class="btn" id="a26">End</button><br>
      <button class="btn" id="a24">QRZ.com</button><button class="btn" id="a25">QRZ.ru</button>
    </td>
    <td class="myq1">
      <button class="btn" id="a01">List</button><button class="btn" id="a02">&#8679;</button><button class="btn" id="a03">&#8681;</button><button class="btn" id="a04">R</button><button class="btn" id="a05">G</button><br>
      <button class="btn" id="a06">LFind</button><button class="btn" id="a07">&#8679;</button><button class="btn" id="a08">&#8681;</button><br>
      <button class="btn" id="a28">LCon</button><button class="btn" id="a29">&#8679;</button><button class="btn" id="a30">&#8681;</button><br>
      <button class="btn" id="b08">ConOO</button><span id="c08"></span><br>
      <button class="btn" id="a27">ConList</button><button class="btn" id="a31">ConScore</button>
    </td>
    <td class="myq1">
      <button class="btn" id="b01">RigOO</button><span id="c01"></span><br>
      <button class="btn" id="b02">S1</button><button class="btn" id="b03">R1</button><br>
      <button class="btn" id="b04">S2</button><button class="btn" id="b05">R2</button><br>
      <button class="btn" id="b06">S3</button><button class="btn" id="b07">R3</button><br>
    </td>
    <td class="myq1">
      <input type="file" id="ff" style="width: 300px"><br>
      <button class="btn" id="a15">adi&#8680;</button><button class="btn" id="a16">lzh&#8680;</button><button class="btn" id="a22">cbr&#8680;</button><br>
      <button class="btn" id="a20">&#8680;adi</button><button class="btn" id="a21">&#8680;cbr</button><br>
      <button class="btn" id="a17">QSL.lotw</button><button class="btn" id="a18">QSL.eqsl</button><button class="btn" id="a19">QSL.qrz</button><br>
    </td>
    <td class="myq1">
      <button class="btn" id="b09">PH</button><span id="c09"></span>
      <button class="btn" id="b10">CW</button><span id="c10"></span>
      <button class="btn" id="b11">DG</button><span id="c11"></span><br>
      <button class="btn" id="b12">10</button><span id="c12"></span>
      <button class="btn" id="b13">15</button><span id="c13"></span>
      <button class="btn" id="b14">20</button><span id="c14"></span><br>
      <button class="btn" id="b15">40</button><span id="c15"></span>
      <button class="btn" id="b16">80</button><span id="c16"></span>
      <button class="btn" id="b17">160</button><span id="c17"></span><br>
      <button class="btn" id="b18">12</button><span id="c18"></span>
      <button class="btn" id="b19">17</button><span id="c19"></span>
      <button class="btn" id="b20">30</button><span id="c20"></span><br>
      <button class="btn" id="b21">60</button><span id="c21"></span><br>
      <button class="btn" id="a13">Cluster</button>
    </td>
    <td class="myq1">
      <span id="o_call"></span><br>
      <span id="o_ota"></span><br>
      <button class="btn" id="a09">Apply</button><button class="btn" id="a10">Report</button><br>
      <button class="btn" id="a11">Curio</button><button class="btn" id="a12">Activity</button>
    </td>
  </table>
</div>
<div class="out" id="out"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script type="module">
const out = document.getElementById("out");
const l01 = document.getElementById("l01");
const l02 = document.getElementById("l02");
let v = new Array(21+1).fill(0);
const inputs = ["call", "freq", "mode", "sigtx", "sigrx", "contest", "contx", "conrx"];
inputs.forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("keydown", e => {
    if (e.key === ",") e.preventDefault();
  });
  el.addEventListener("input", () => {
    el.value = el.value.replace(/,/g, "").toUpperCase();
  });
});
let page = 0;
let mypage = 30;
let ota = "";
let b02f, b02m, b04f, b04m, b06f, b06m;

function setchecks() {
  for (let i = 1; i <= 21; i++) {
    const id = "c" + String(i).padStart(2, "0");
    const el = document.getElementById(id);
    if (el) {
      el.textContent = v[i] === 1 ? "☑️" : "☐";
    }
  }
}
 
document.querySelectorAll("button[id]").forEach(btn => {
  if (/^a\d{2}$/.test(btn.id)) {
    btn.addEventListener("click", async () => {
      const num = parseInt(btn.id.slice(1), 10);
      if (num == 1 || num == 6 || num == 28) page = 0;
      else if (num == 2 || num == 7 || num == 29) page -= mypage;
      else if (num == 3 || num == 8 || num == 30) page += mypage;
      let data = "";
      if (num >= 15 && num <= 22) {
        const file = document.getElementById("ff").files[0];
        if (file) {
          const plainStream = file.stream();
          const plainBlob = await new Response(plainStream).blob();
          const buf = await plainBlob.arrayBuffer();
          let chunk = 0x8000, bytes = new Uint8Array([...new Uint8Array(buf), 0x20, 0x20, 0x20, 0x20]);
          let binary = "";
          for (let i = 0; i < bytes.length; i += chunk) {
            binary += String.fromCharCode(...bytes.subarray(i, i + chunk));
          }
          data = btoa(binary);
        }
      }
      if (page < 0) page = 0;
      const body = [
        ota,
        btn.id,
        page,
        mypage,
        ...inputs.map(id => document.getElementById(id)?.value.trim() || "-"),
        v.slice(9, 22).join(''),
        data
      ].join(",");
      out.textContent = "Waiting";
      const r = await fetch("proclog.cgi", {
        method: "POST", cache: "no-store", credentials: "same-origin",
        headers: {"Content-Type": "text/csv"},
        body
      });
      if (num == 5) {
        page = parseInt(await r.text(), 10) || 0;
        document.getElementById("a04").click();
      }
      else out.innerHTML = await r.text();
    });
  }
  else if (btn.id === "l03") {
    btn.addEventListener("click", async () => {
      const r = await fetch("plogin.cgi", {
        method: "POST", cache: "no-store", credentials: "same-origin",
        headers: {"Content-Type": "text/csv"},
        body: [l01.value.trim().toUpperCase(),CryptoJS.MD5(l02.value).toString()].join(",")
      });
      ota = (await r.text()).trim();
      if (ota.length === 16) {
        hh2.style.display = "block";
        hh1.style.display = "none";
        document.getElementById("o_call").innerHTML = l01.value.trim().toUpperCase();
        document.getElementById("o_ota").innerHTML = ota;
      }
    });
  }
  else if (/^b\d{2}$/.test(btn.id)) {
    btn.addEventListener("click", async () => {
      const num = parseInt(btn.id.slice(1), 10);
      switch (num) {
        case 1:
          v[1] = 1 - v[1];
          if (v[1] === 1) {
            document.getElementById("freq").disabled = true;
            document.getElementById("mode").disabled = true;
          } 
          else {
            document.getElementById("freq").disabled = false;
            document.getElementById("mode").disabled = false;
          }
          break;
        case 2:
          b02f = document.getElementById("freq").value;
          b02m = document.getElementById("mode").value;
          break;
        case 3:
          if (v[1] === 1 && typeof b02f !== "undefined" && typeof b02m !== "undefined") {
            document.getElementById("freq").value = b02f;
            document.getElementById("mode").value = b02m;
          }
          break;
        case 4:
          b04f = document.getElementById("freq").value;
          b04m = document.getElementById("mode").value;
          break;
        case 5:
          if (v[1] === 1 && typeof b04f !== "undefined" && typeof b04m !== "undefined") {
            document.getElementById("freq").value = b04f;
            document.getElementById("mode").value = b04m;
          }
          break;
        case 6:
          b06f = document.getElementById("freq").value;
          b06m = document.getElementById("mode").value;
          break;
        case 7:
          if (v[1] === 1 && typeof b06f !== "undefined" && typeof b06m !== "undefined") {
            document.getElementById("freq").value = b06f;
            document.getElementById("mode").value = b06m;
          }
          break;
        case 8:
          v[8] = 1 - v[8];
          if (v[8] === 1) {
            document.getElementById("contest").disabled = false;
            document.getElementById("contx").disabled = false;
            document.getElementById("conrx").disabled = false;
          }
          else {
            document.getElementById("contest").disabled = true;
            document.getElementById("contx").disabled = true;
            document.getElementById("conrx").disabled = true;
          }
          break;
        default:
          v[num] = 1 - v[num];
          break;
      }
      setchecks();
    });
  }
});

window.cmd1 = async (a,b) => {
  const p = prompt("DEL DELETE FT=xxx FREQTX=xxx FR=xxx FREQRX=xxx M=xxx MODE=xxx ST=xxx SIGNALTX=xxx SR=xxx SIGNALRX=xxx C=xxx CALL=xxx DTS=xxx DATETIMESTART=xxx DTE=xxx DATETIMEEND=xxx CO=xxx CONTEST=xxx COT=xxx CONTESTTX=xxx COR=xxx CONTESTRX=xxx","");
  if (p) {
    const r = await fetch("pcmd.cgi", {
      method: "POST",
      cache: "no-store",
      credentials: "same-origin",
      headers: { "Content-Type": "text/csv" },
      body: [ota, a, b, p.toUpperCase()].join(",")
    });
  }
};

window.cmd2 = async (a) => {
  document.getElementById("contest").value = a;
};

window.cmd3 = async (a,b) => {
  document.getElementById("call").value = a;
  document.getElementById("freq").value = b;
};

setInterval(() => {
  if (/^Waiting/i.test(out.textContent)) out.textContent += ".";
}, 1000);

async function radioread() {
  if (v[1] === 0) return;
  const r = await fetch("pradioread.cgi", {
    method: "POST",
    cache: "no-store",
    credentials: "same-origin",
    headers: { "Content-Type": "text/csv" },
    body: ota
  });
  const text = await r.text();
  const [freq, mode] = text.split(",");

  const fff = (freq / 1000).toFixed(1);
  document.getElementById("freq").value = fff;
  document.getElementById("mode").value = mode;
}
setInterval(radioread, 10000);
radioread();
setchecks();
hh2.style.display = "none";
hh1.style.display = "block";
document.getElementById("sigtx").value = "59";
document.getElementById("sigrx").value = "59";
  
</script>
</body>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-store">
  <title>LOG by IK4LZH v2.0</title>
  <link rel="stylesheet" href="log.css?v=117">
</head>
<body>
<div id="hh1">
  <input class="myf2" id="l01" placeholder="login" maxlength="6" minlength="4" required>
  <input class="myf2" id="l02" type="password" placeholder="password" maxlength="16" minlength="6" required>
  <button class="btn" id="l03">LOGIN</button>
</div>
<div id="hh2">
  <table>
    <td class="myq1"><table>
      <tr><td><label class="myf1">Call</label></td><td><input class="myf2" id="call" maxlength="20" size="10" autocomplete="off"></td></tr>
      <tr><td><label class="myf1">Freq</label></td><td><input class="myf2" id="freq" maxlength="10" size="10" autocomplete="off"></td></tr>
      <tr><td><label class="myf1">Mode</label></td><td><input class="myf2" type="text" id="mode" maxlength="8" size="6" autocomplete="off"></td></tr>
      <tr><td><label class="myf1">SigTX</label></td><td><input class="myf2" type="text" id="sigtx" maxlength="10" size="6" autocomplete="off"></td></tr>
      <tr><td><label class="myf1">SigRX</label></td><td><input class="myf2" type="text" id="sigrx" maxlength="10" size="6" autocomplete="off"></td></tr>
      <tr><td><label class="myf1">Contest</label></td><td><input class="myf2" disabled type="text" id="contest" maxlength="12" size="12" autocomplete="off"></td></tr>
      <tr><td><label class="myf1">ConTx</label></td><td><input class="myf2" disabled type="text" id="contx" maxlength="12" size="12" autocomplete="off"></td></tr>
      <tr><td><label class="myf1">ConRx</label></td><td><input class="myf2" disabled type="text" id="conrx" maxlength="12" size="12" autocomplete="off"></td></tr>
      </table> 
      <button class="btn" id="a23">Start</button><button class="btn" id="a26">End</button><br>
      <button class="btn" id="a24">QRZ.com</button><button class="btn" id="a25">QRZ.ru</button>
    </td>
    <td class="myq1">
      <button class="btn" id="t51">51</button><br>
      <button class="btn" id="t53">53</button><br>
      <button class="btn" id="t55">55</button><br>
      <button class="btn" id="t56">56</button><br>
      <button class="btn" id="t57">57</button><br>
      <button class="btn" id="t58">58</button><br>
      <button class="btn" id="t59">59</button><br>
      <button class="btn" id="t59+10">59+10</button><br>
      <button class="btn" id="t59+20">59+20</button>
    </td>
    <td class="myq1">
      <button class="btn" id="r51">51</button><br>
      <button class="btn" id="r53">53</button><br>
      <button class="btn" id="r55">55</button><br>
      <button class="btn" id="r56">56</button><br>
      <button class="btn" id="r57">57</button><br>
      <button class="btn" id="r58">58</button><br>
      <button class="btn" id="r59">59</button><br>
      <button class="btn" id="r59+10">59+10</button><br>
      <button class="btn" id="r59+20">59+20</button>
    </td>
    <td class="myq1">
      <button class="btn" id="a01">List</button><button class="btn" id="a02">&#8679;</button><button class="btn" id="a03">&#8681;</button><button class="btn" id="a04">R</button><button class="btn" id="a05">G</button><br>
      <button class="btn" id="a06">LFind</button><button class="btn" id="a07">&#8679;</button><button class="btn" id="a08">&#8681;</button><br>
      <button class="btn" id="a28">LCon</button><button class="btn" id="a29">&#8679;</button><button class="btn" id="a30">&#8681;</button><br>
      <button class="btn" id="b08">ConOO</button><span id="c08"></span><button class="btn" id="b22">ConTX++</button><span id="c22"></span><br>
      <button class="btn" id="a27">ConList</button><button class="btn" id="a31">ConScore</button><br>
      <button class="btn" id="a14">ConGraph</button>
    </td>
    <td class="myq1">
      <button class="btn" id="b01">RigOO</button><span id="c01"></span><br>
      <button class="btn" id="b02">RTX&#8680;1</button><button class="btn" id="b03">1&#8680;RTX</button><br>
      <span id="c23"></span><br>
      <button class="btn" id="b04">RTX&#8680;2</button><button class="btn" id="b05">2&#8680;RTX</button><br>
      <span id="c45"></span><br>
      <button class="btn" id="b06">RTX&#8680;3</button><button class="btn" id="b07">3&#8680;RTX</button><br>
      <span id="c67"></span>
    </td>
    <td class="myq1">
      <input type="file" id="ff" hidden>
      <label class="btn" for="ff">File</label><br>
      <button class="btn" id="a15">adi&#8680;</button><button class="btn" id="a16">lzh&#8680;</button><button class="btn" id="a22">cbr&#8680;</button><br>
      <button class="btn" id="a20">&#8680;adi</button><button class="btn" id="a21">&#8680;cbr</button><br>
      <button class="btn" id="a17">QSL.lotw</button><br>
      <button class="btn" id="a18">QSL.eqsl</button><br>
      <button class="btn" id="a19">QSL.qrz</button>
    </td>
    <td class="myq1">
      <button class="btn" id="b09">PH</button><span id="c09"></span>
      <button class="btn" id="b10">CW</button><span id="c10"></span>
      <button class="btn" id="b11">DG</button><span id="c11"></span><br>
      <button class="btn" id="b12">10</button><span id="c12"></span>
      <button class="btn" id="b13">15</button><span id="c13"></span>
      <button class="btn" id="b14">20</button><span id="c14"></span><br>
      <button class="btn" id="b15">40</button><span id="c15"></span>
      <button class="btn" id="b16">80</button><span id="c16"></span>
      <button class="btn" id="b17">160</button><span id="c17"></span><br>
      <button class="btn" id="b18">12</button><span id="c18"></span>
      <button class="btn" id="b19">17</button><span id="c19"></span>
      <button class="btn" id="b20">30</button><span id="c20"></span><br>
      <button class="btn" id="b21">60</button><span id="c21"></span><br>
      <button class="btn" id="a13">Cluster</button>
    </td>
    <td class="myq1">
      <h1><span id="o_call"></span></h1>
      <span id="o_time"></span><br>
      <span id="o_ota"></span><br>
      <button class="btn" id="a09">Apply</button><button class="btn" id="a10">Report</button><br>
      <button class="btn" id="a11">Curio</button><button class="btn" id="a12">Activity</button><br>
      <label class="myf1">MyPage </label><input class="myf2" id="mypage" maxlength="3" size="3" autocomplete="off"><br>
      <label class="myf1">Base </label><span id="base"></span><br>
      <label class="myf1">Release </label><span id="release"></span><br>
    </td>
  </table>
</div>
<div class="out" id="out"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script type="module">
const out = document.getElementById("out");
const l01 = document.getElementById("l01");
const l02 = document.getElementById("l02");
const imypage = document.getElementById("mypage");
let v = new Array(22+1).fill(0);
  
const inputs = ["call", "freq", "mode", "sigtx", "sigrx", "contest", "contx", "conrx"];
inputs.forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("keydown", e => {
    if (e.key === ",") e.preventDefault();
    if (id === "call" && e.key === "Enter") {
      e.preventDefault();
      document.getElementById("a23").click();
    }
  });
  el.addEventListener("input", async () => {
    const pos = el.selectionStart;
    const newValue = el.value.replace(/,/g, "").toUpperCase();
    const diff = el.value.length - newValue.length;
    el.value = newValue;
    el.setSelectionRange(pos - diff, pos - diff);
    if (id === "call") {
      const r = await fetch("pguess.cgi", {
        method: "POST",
        cache: "no-store",
        credentials: "same-origin",
        headers: { "Content-Type": "text/plain" },
        body: el.value
       });
       out.innerHTML = await r.text();
    }
  });
});
  
let base = 0;
let mypage = 0;
let mysync = 0;
let delta = 0;
let ota = "";
let filter = "";
let start = "";
let b02f, b02m, b04f, b04m, b06f, b06m;

function setchecks() {
  for (let i = 1; i <= 22; i++) {
    const id = "c" + String(i).padStart(2, "0");
    const el = document.getElementById(id);
    if (el) {
      el.textContent = v[i] === 1 ? "☑️" : "☐";
    }
  }
}
 
document.querySelectorAll("button[id]").forEach(btn => {
  if (/^a\d{2}$/.test(btn.id)) {
    btn.addEventListener("click", async () => {
      const num = parseInt(btn.id.slice(1), 10);
      if (num == 1 || num == 6 || num == 28) base = 0;
      else if (num == 2 || num == 7 || num == 29) base -= mypage;
      else if (num == 3 || num == 8 || num == 30) base += mypage;
      let data = "";
      if (num >= 15 && num <= 22) {
        const file = document.getElementById("ff").files[0];
        if (file) {
          const plainStream = file.stream();
          const plainBlob = await new Response(plainStream).blob();
          const buf = await plainBlob.arrayBuffer();
          let chunk = 0x8000, bytes = new Uint8Array([...new Uint8Array(buf), 0x20, 0x20, 0x20, 0x20]);
          let binary = "";
          for (let i = 0; i < bytes.length; i += chunk) {
            binary += String.fromCharCode(...bytes.subarray(i, i + chunk));
          }
          data = btoa(binary);
        }
      }
      if (base < 0) base = 0;
      document.getElementById("base").textContent = base;
      
      const body = [
        ota,
        btn.id,
        base,
        mypage,
        ...inputs.map(id => document.getElementById(id)?.value.trim() || "-"),
        num === 13 ? v.slice(9, 22).join('') : num === 26 ? start : '',
        data
      ].join(",");
      out.textContent = "Waiting";
      const r = await fetch("pproc.cgi", {
        method: "POST", cache: "no-store", credentials: "same-origin",
        headers: {"Content-Type": "text/csv"},
        body
      });
      if (num == 5) {
        base = parseInt(await r.text(), 10) || 0;
        document.getElementById("a04").click();
      }
      else out.innerHTML = await r.text();
      if (num == 23) {
        const match = out.innerText.match(/Start:\s*(.+)/);
        if (match) start = match[1].trim();
        else start = "";
      }
      if (num == 26) {
        start = "";
        if (v[22] === 1) document.getElementById("contx").value = parseInt(document.getElementById("contx").value) + 1;
      }
    });
  }
  else if (btn.id === "l03") {
    btn.addEventListener("click", async () => {
      const r = await fetch("plogin.cgi", {
        method: "POST", cache: "no-store", credentials: "same-origin",
        headers: {"Content-Type": "text/csv"},
        body: [l01.value.trim().toUpperCase(),CryptoJS.MD5(l02.value).toString()].join(",")
      });
      [ota, mypage, filter] = (await r.text()).trim().split(",");
      mypage = Number(mypage);
      if (ota.length === 16) {
        hh2.style.display = "block";
        hh1.style.display = "none";
        document.getElementById("o_call").textContent = l01.value.trim().toUpperCase();
        document.getElementById("o_ota").textContent = ota;
        document.getElementById("mypage").value = mypage;
        for (let i = 0; i < 13; i++) v[9 + i] = +filter[i];
        setchecks();
      }
    });
  }
  else if (/^b\d{2}$/.test(btn.id)) {
    btn.addEventListener("click", async () => {
      const num = parseInt(btn.id.slice(1), 10);
      switch (num) {
        case 1:
          v[1] = 1 - v[1];
          if (v[1] === 1) {
            document.getElementById("freq").disabled = true;
            document.getElementById("mode").disabled = true;
          } 
          else {
            document.getElementById("freq").disabled = false;
            document.getElementById("mode").disabled = false;
          }
          break;
        case 2:
          b02f = document.getElementById("freq").value;
          b02m = document.getElementById("mode").value;
          document.getElementById("c23").textContent = b02f + ":" + b02m;
          break;
        case 3:
          if (v[1] === 1 && typeof b02f !== "undefined" && typeof b02m !== "undefined") {
            document.getElementById("freq").value = b02f;
            document.getElementById("mode").value = b02m;
            radioset(b02f,b02m);
          }
          break;
        case 4:
          b04f = document.getElementById("freq").value;
          b04m = document.getElementById("mode").value;
          document.getElementById("c45").textContent = b04f + ":" + b04m;
          break;
        case 5:
          if (v[1] === 1 && typeof b04f !== "undefined" && typeof b04m !== "undefined") {
            document.getElementById("freq").value = b04f;
            document.getElementById("mode").value = b04m;
            radioset(b04f,b04m);
          }
          break;
        case 6:
          b06f = document.getElementById("freq").value;
          b06m = document.getElementById("mode").value;
          document.getElementById("c67").textContent = b06f + ":" + b06m;
          break;
        case 7:
          if (v[1] === 1 && typeof b06f !== "undefined" && typeof b06m !== "undefined") {
            document.getElementById("freq").value = b06f;
            document.getElementById("mode").value = b06m;
            radioset(b06f,b06m);
          }
          break;
        case 8:
          v[8] = 1 - v[8];
          if (v[8] === 1) {
            document.getElementById("contest").disabled = false;
            document.getElementById("contx").disabled = false;
            document.getElementById("conrx").disabled = false;
          }
          else {
            document.getElementById("contest").disabled = true;
            document.getElementById("contx").disabled = true;
            document.getElementById("conrx").disabled = true;
          }
          break;
        default:
          v[num] = 1 - v[num];
          break;
      }
      setchecks();
    });
  }
  else  if (/^t.*/.test(btn.id)) {
    btn.addEventListener("click", async (t) => {
      document.getElementById("sigtx").value = t.currentTarget.id.slice(1);
    });
  }
  else  if (/^r.*/.test(btn.id)) {
    btn.addEventListener("click", async (r) => {
      document.getElementById("sigrx").value = r.currentTarget.id.slice(1);
    });
  }
});

window.cmd1 = async (a,b) => {
  const p = prompt("DEL DELETE FT=xxx FREQTX=xxx FR=xxx FREQRX=xxx M=xxx MODE=xxx ST=xxx SIGNALTX=xxx SR=xxx SIGNALRX=xxx C=xxx CALL=xxx DTS=xxx DATETIMESTART=xxx DTE=xxx DATETIMEEND=xxx CO=xxx CONTEST=xxx COT=xxx CONTESTTX=xxx COR=xxx CONTESTRX=xxx","");
  if (p) {
    const r = await fetch("pcmd.cgi", {
      method: "POST",
      cache: "no-store",
      credentials: "same-origin",
      headers: { "Content-Type": "text/csv" },
      body: [ota, a, b, p.toUpperCase()].join(",")
    });
  }
};

window.cmd2 = async (a) => {
  document.getElementById("contest").value = a;
};

window.cmd3 = async (a,b) => {
  document.getElementById("call").value = a;
  document.getElementById("freq").value = b;
  radioset(b,document.getElementById("mode").value);
};

window.cmd4 = async (a) => {
  document.getElementById("call").value = a;
};

setInterval(() => {
  if (/^Waiting/i.test(out.textContent)) out.textContent += ".";
}, 333);

async function radioread() {
  if (v[1] === 0) return;
  const r = await fetch("pradio.cgi", {
    method: "POST",
    cache: "no-store",
    credentials: "same-origin",
    headers: { "Content-Type": "text/csv" },
    body: [ota, "R", "0,ND"].join(",")
  });
  const text = await r.text();
  const [freq, mode] = text.split(",");
  const fff = (freq / 1000).toFixed(1);
  document.getElementById("freq").value = fff;
  document.getElementById("mode").value = mode;
}

window.radioset = async (a,b) => {
  if (v[1] === 0) return;
  const aa = Math.round(a * 1000);
  const r = await fetch("pradio.cgi", {
    method: "POST",
    cache: "no-store",
    credentials: "same-origin",
    headers: { "Content-Type": "text/csv" },
    body: [ota, "S", `${aa}:${b}`].join(",")
  });
  const text = await r.text();
  const [freq, mode] = text.split(",");
  const fff = (freq / 1000).toFixed(1);
  document.getElementById("freq").value = fff;
  document.getElementById("mode").value = mode;
}
 
window.timeupdate = async () => {
  mysync++;
  if (mysync == 60){
    mysync = 0;
    const r = await fetch("ptime.cgi");
    const t = await r.text();
    delta = Number(t) - Math.floor(Date.now() / 1000);
  }
  const d = new Date(Date.now() + delta * 1000);
  const YYYY = d.getUTCFullYear();
  const MM = String(d.getUTCMonth() + 1).padStart(2, '0');
  const DD = String(d.getUTCDate()).padStart(2, '0');
  const hHH = String(d.getUTCHours()).padStart(2, '0');
  const mm = String(d.getUTCMinutes()).padStart(2, '0');
  const ss = String(d.getUTCSeconds()).padStart(2, '0');
  document.getElementById("o_time").textContent = `${YYYY}-${MM}-${DD} ${hHH}:${mm}:${ss} UTC`;
}

imypage.addEventListener("input", () => {
    mypage = Number(imypage.value);
});

setInterval(radioread, 10000);
radioread();
setInterval(timeupdate, 1000);
timeupdate();
setchecks();
hh2.style.display = "none";
hh1.style.display = "block";
document.getElementById("sigtx").value = "59";
document.getElementById("sigrx").value = "59";
document.getElementById("base").textContent = base;
document.getElementById("release").textContent = "xxxxxxxx";

google.charts.load('current',{packages:['corechart']});

function renderCharts(root=document){
  google.charts.setOnLoadCallback(()=> {
    root.querySelectorAll(".gchart").forEach(el=>{
      const rows = JSON.parse(el.dataset.rows);
      const d = new google.visualization.DataTable();
      d.addColumn('datetime','T');
      d.addColumn('number','QSO');
      d.addColumn('number','Punti');
      d.addColumn('number','Molt');
      d.addColumn('number','Score');
      d.addRows(rows.map(r=>[new Date(r[0]), r[1], r[2], r[3], r[4]]));
      new google.visualization.LineChart(el).draw(d,{
        legend:{position:'bottom'},
        hAxis:{format:'HH:mm'},
        vAxes:{0:{title:'QSO/Punti/Molt'},1:{title:'Score'}},
        series:{
          0:{targetAxisIndex:0,pointsVisible:1},
          1:{targetAxisIndex:0,pointsVisible:1},
          2:{targetAxisIndex:0,pointsVisible:1},
          3:{targetAxisIndex:1,pointsVisible:1}
        }
      });
    });
  });
}
  
</script>
</body>
